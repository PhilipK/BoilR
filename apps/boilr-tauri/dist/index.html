<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BoilR Desktop Preview</title>
    <style>
      :root {
        color-scheme: dark;
        --bg: #15161d;
        --panel: #1f2130;
        --panel-border: #2b2d3f;
        --accent: #ff7f50;
        --accent-soft: #ffa379;
        --text: #f5f5f5;
        --muted: #9799b7;
        --error: #ff6b6b;
        font-family: "Inter", "Segoe UI", sans-serif;
      }

      body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        padding: 1.75rem 2.5rem 1rem;
        background: linear-gradient(135deg, rgba(255, 127, 80, 0.25), transparent);
        border-bottom: 1px solid var(--panel-border);
      }

      header h1 {
        margin: 0 0 0.4rem;
        font-size: 2rem;
        letter-spacing: 0.02em;
      }

      header p {
        margin: 0;
        color: var(--muted);
      }

      main {
        flex: 1;
        padding: 1.5rem 2.5rem 2.5rem;
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        align-content: start;
      }

      section {
        background: var(--panel);
        border: 1px solid var(--panel-border);
        border-radius: 14px;
        padding: 1.25rem 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.9rem;
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.18);
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
      }

      .section-header h2 {
        margin: 0;
        font-size: 1.15rem;
        letter-spacing: 0.01em;
      }

      button {
        background: var(--accent);
        color: #0b0c11;
        border: none;
        border-radius: 8px;
        padding: 0.55rem 1.1rem;
        font-size: 0.95rem;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.1s ease;
      }

      button:hover {
        background: var(--accent-soft);
      }

      button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        transform: none !important;
      }

      button:active:not(:disabled) {
        transform: translateY(1px);
      }

      #sync-status {
        font-size: 0.95rem;
        color: var(--muted);
      }

      #sync-result {
        background: rgba(255, 127, 80, 0.12);
        border-radius: 10px;
        padding: 0.85rem;
        border: 1px solid rgba(255, 127, 80, 0.25);
        font-size: 0.95rem;
      }

      pre {
        background: rgba(0, 0, 0, 0.22);
        border-radius: 10px;
        padding: 0.9rem;
        overflow-x: auto;
        margin: 0;
        font-size: 0.9rem;
        line-height: 1.45;
        border: 1px solid rgba(255, 255, 255, 0.04);
      }

      .platform-card {
        border: 1px solid var(--panel-border);
        border-radius: 12px;
        padding: 0.95rem;
        margin-bottom: 0.85rem;
        background: rgba(255, 255, 255, 0.02);
        display: flex;
        flex-direction: column;
        gap: 0.55rem;
      }

      .platform-card.disabled {
        opacity: 0.55;
      }

      .platform-card header {
        background: none;
        border: none;
        padding: 0;
        margin: 0;
      }

      .platform-meta {
        display: flex;
        gap: 0.85rem;
        align-items: center;
        flex-wrap: wrap;
        color: var(--muted);
        font-size: 0.85rem;
      }

      .badge {
        background: rgba(255, 127, 80, 0.18);
        border-radius: 999px;
        padding: 0.1rem 0.6rem;
        color: var(--accent);
        font-weight: 600;
        letter-spacing: 0.02em;
      }

      .error-text {
        color: var(--error);
        font-size: 0.9rem;
      }

      details {
        background: rgba(0, 0, 0, 0.18);
        border-radius: 8px;
        padding: 0.6rem 0.8rem;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      summary {
        cursor: pointer;
        font-weight: 600;
        color: var(--muted);
      }

      ul {
        list-style: none;
        padding: 0.4rem 0 0 1.2rem;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }

      li {
        color: var(--text);
        font-size: 0.9rem;
      }

      .muted {
        color: var(--muted);
      }

      .errors-list {
        margin-top: 0.6rem;
        border-top: 1px solid rgba(255, 255, 255, 0.07);
        padding-top: 0.6rem;
        display: flex;
        flex-direction: column;
        gap: 0.45rem;
      }

      .small {
        font-size: 0.85rem;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>BoilR Desktop Preview</h1>
      <p>Interact with the Rust core through the new Tauri shell.</p>
    </header>
    <main>
      <section id="sync-panel">
        <div class="section-header">
          <h2>Synchronisation</h2>
          <button id="run-sync">Run Import Pipeline</button>
        </div>
        <div id="sync-status" class="muted">Steam import has not been triggered yet.</div>
        <div id="sync-result" hidden></div>
      </section>

      <section>
        <div class="section-header">
          <h2>Settings Snapshot</h2>
          <button id="reload-settings">Reload Settings</button>
        </div>
        <pre id="settings-output">Loading settings...</pre>
      </section>

      <section class="platforms">
        <div class="section-header">
          <h2>Platform Discovery</h2>
          <button id="refresh-platforms">Refresh Platforms</button>
        </div>
        <div id="platform-list" class="muted">Collecting platform data...</div>
      </section>
    </main>

    <script>
      let invoke = null;

      async function resolveBridge(maxWaitMs = 4000) {
        const start = Date.now();
        while (Date.now() - start < maxWaitMs) {
          const bridge = window.__TAURI__;
          if (bridge?.invoke) {
            invoke = bridge.invoke.bind(bridge);
            break;
          }
          if (bridge?.core?.invoke) {
            invoke = bridge.core.invoke.bind(bridge.core);
            break;
          }
          await new Promise((resolve) => setTimeout(resolve, 50));
        }

        if (!invoke) {
          console.error("Tauri IPC bridge not available");
          document.getElementById("settings-output").textContent =
            "Tauri IPC bridge not available. Ensure the app is running inside the Tauri shell.";
          document.getElementById("platform-list").textContent =
            "Tauri IPC bridge not available.";
          document.getElementById("sync-status").textContent =
            "Commands unavailable.";
          document.getElementById("run-sync").disabled = true;
          document.getElementById("reload-settings").disabled = true;
          document.getElementById("refresh-platforms").disabled = true;
        }
      }

      const settingsOutput = document.getElementById("settings-output");
      const platformList = document.getElementById("platform-list");
      const syncStatus = document.getElementById("sync-status");
      const syncResult = document.getElementById("sync-result");

      const reloadSettingsBtn = document.getElementById("reload-settings");
      const refreshPlatformsBtn = document.getElementById("refresh-platforms");
      const runSyncBtn = document.getElementById("run-sync");

      function setBusy(button, busy) {
        button.disabled = busy;
        if (busy) {
          button.dataset.label = button.textContent;
          button.textContent = "Working...";
        } else if (button.dataset.label) {
          button.textContent = button.dataset.label;
          delete button.dataset.label;
        }
      }

      async function loadSettings() {
        if (!invoke) return;
        setBusy(reloadSettingsBtn, true);
        try {
          const settings = await invoke("load_settings");
          settingsOutput.textContent = JSON.stringify(settings, null, 2);
        } catch (err) {
          console.error(err);
          settingsOutput.textContent = `Failed to load settings: ${err}`;
        } finally {
          setBusy(reloadSettingsBtn, false);
        }
      }

      function renderGameList(games) {
        if (!games.length) {
          return "<p class=\"muted\">No games detected.</p>";
        }

        const items = games
          .slice(0, 12)
          .map((game) => {
            const flags = [];
            if (game.needs_proton) flags.push("proton");
            if (game.needs_symlinks) flags.push("symlinks");
            if (game.blacklisted) flags.push("blacklisted");
            const flagLabel = flags.length
              ? `<span class=\"muted small\">(${flags.join(", ")})</span>`
              : "";
            return `<li>${game.display_name} ${flagLabel}</li>`;
          })
          .join("");

        const remainder = games.length > 12
          ? `<div class=\"muted small\">… and ${games.length - 12} more</div>`
          : "";

        return `<details><summary>Show games (${games.length})</summary><ul>${items}</ul>${remainder}</details>`;
      }

      async function refreshPlatforms() {
        if (!invoke) return;
        setBusy(refreshPlatformsBtn, true);
        platformList.textContent = "Collecting platform data...";

        try {
          const platforms = await invoke("discover_games");
          if (!platforms.length) {
            platformList.textContent = "No platforms reported data.";
            return;
          }

          platformList.innerHTML = platforms
            .map((platform) => {
              const badge = platform.enabled ? "Enabled" : "Disabled";
              const badgeClass = platform.enabled ? "badge" : "badge muted";
              const errorBlock = platform.error
                ? `<div class=\"error-text\">${platform.error}</div>`
                : "";

              return `
                <article class=\"platform-card ${platform.enabled ? "" : "disabled"}\">
                  <header>
                    <h3>${platform.name}</h3>
                    <div class=\"platform-meta\">
                      <span class=\"${badgeClass}\">${badge}</span>
                      <span class=\"muted\">Code: ${platform.code_name}</span>
                      <span class=\"muted\">Detected games: ${platform.games.length}</span>
                    </div>
                  </header>
                  ${errorBlock || renderGameList(platform.games)}
                </article>
              `;
            })
            .join("");
        } catch (err) {
          console.error(err);
          platformList.innerHTML = `<div class=\"error-text\">Failed to load platform data: ${err}</div>`;
        } finally {
          setBusy(refreshPlatformsBtn, false);
        }
      }

      function renderSyncOutcome(outcome) {
        const { imported_platforms, shortcuts_considered, steam_users_updated, images_requested, platform_errors } = outcome;

        const lines = [
          `<div>Platforms processed: <strong>${imported_platforms}</strong></div>`,
          `<div>Shortcut candidates: <strong>${shortcuts_considered}</strong></div>`,
          `<div>Steam user folders touched: <strong>${steam_users_updated}</strong></div>`,
          `<div>Artwork download requested: <strong>${images_requested ? "yes" : "no"}</strong></div>`,
        ];

        if (platform_errors.length) {
          const errorItems = platform_errors
            .map((err) => `<div><strong>${err.name}</strong>: ${err.message}</div>`)
            .join("");
          lines.push(`<div class=\"errors-list\"><div class=\"error-text\">Warnings:</div>${errorItems}</div>`);
        }

        syncResult.innerHTML = lines.join("");
        syncResult.hidden = false;
      }

      async function runSync() {
        if (!invoke) return;
        setBusy(runSyncBtn, true);
        syncStatus.textContent = "Running import pipeline…";
        syncResult.hidden = true;

        try {
          const outcome = await invoke("run_full_sync");
          syncStatus.textContent = "Import finished.";
          renderSyncOutcome(outcome);
          await refreshPlatforms();
        } catch (err) {
          console.error(err);
          syncStatus.textContent = `Import failed: ${err}`;
        } finally {
          setBusy(runSyncBtn, false);
        }
      }

      reloadSettingsBtn.addEventListener("click", loadSettings);
      refreshPlatformsBtn.addEventListener("click", refreshPlatforms);
      runSyncBtn.addEventListener("click", runSync);

      resolveBridge().then(() => {
        if (invoke) {
          loadSettings();
          refreshPlatforms();
        }
      });
    </script>
  </body>
</html>
